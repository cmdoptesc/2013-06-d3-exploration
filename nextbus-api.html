<html>
  <head>
    <title></title>
    <script type="text/javascript" src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.2.2/d3.v3.min.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.1/underscore-min.js"></script>
  </head>
  <body>

    <form>
      <select id="routeSelector"></select>

      <select id="directionSelector"></select>

      <select id="stopSelector"></select>

      <select id="destSelector"></select>

      <input type="button" value="Select Stop" id="buttonRoute" />

    </form>

    <div class="chartsDiv"></div>

    <script type="text/javascript">
      var routeTag,
        routes,
        stopsInfo,
        stopId;

      var charts = [];

      $(function(){

        $("#routeSelector").change(function(){
          routeTag = $("#routeSelector").val();
          getRoute(routeTag);
        });

        $("#directionSelector").change(function(){
          var dirTag = $("#directionSelector").val();
          displayStops(stopsInfo, routes, dirTag);
        });

        $("#stopSelector").change(function(){
          stopId = $("#stopSelector").val();

          if(charts[0]) {
            updateChart(stopId, routeTag, charts[charts.length-1]);
          }
        });

        $("#buttonRoute").click(function(){
          stopId = $("#stopSelector").val();
          charts.push(makeChart(stopId, routeTag));
        })

        var makeChart = function(stop, route) {
          console.log(route);
          chart = {};
          chart.vis = d3.select(".chartsDiv").insert("svg:svg",":first-child")
                      .attr('width', w)
                      .attr('height', h)
                      .style('border', '1px solid black');

          getStopTimes(stop, route, render, chart.vis, routesList[route]);
          chart.timer = setInterval(function(){
            getStopTimes(stop,route, render, chart.vis);
          }, 12000);

          return chart;
        }

        var updateChart = function(stop, route, chart) {
          window.clearInterval(chart.timer);
          $(chart.vis[0]).empty();
          getStopTimes(stop, route, render, chart.vis, routeList[route]);
          chart.timer = setInterval(function(){
            getStopTimes(stop,route, render, chart.vis);
          }, 12000);
        }

        var w = 900,
            h = 500;

        var xPad = 10,
            yPad = 10,
            barPad = 1;

        var divisor = 5;

        var xScale = d3.scale.linear()
                        .domain([])
                        .range([xPad,w-xPad]);

        var render = function(dataset, svgElement, route) {
          var vis = svgElement;

          console.log("dataset: ", dataset);

          var bar = vis.selectAll('rect');
          var minTxt = vis.selectAll("text");

          var skipFlag = false;
          var tr_time = 10500;

            // checking if the bus rolls off the stop
            //    condition: if the last reported time was <30s and the new time is 90s greater
          if(bar[0] && bar[0][0]) {
            var pWidth = parseInt(d3.select(bar[0][0]).attr("width"))*divisor;
            if( (pWidth < 30) && (parseInt(dataset[0]) - pWidth) > 90 ) {
              skipFlag = true;
              tr_time = 5000;
              bar[0][0].remove();
              minTxt[0][0].remove();
              bar[0].splice(0,1);
              minTxt[0].splice(0,1);
            } else {
              skipFlag = false;
            }
          }

          if(route) {
            vis.append("text")
                .text(route)
                .attr("x", w-xPad-30)
                .attr("y", yPad);
          }

          var barProperties = function(obj){
            obj.attr("y", function(d, i) {
                  return i * (h / (dataset.length)) + yPad;
                })
                .attr("width", function(d) {
                  return Math.floor(d/divisor);
                })
                .attr("height", (h - 2*yPad)/dataset.length - barPad)
                .attr("fill", function(d) {
                  var g = Math.floor((1 - d/5000)*255);
                  return "rgb(0, "+ g +", 0)";
                });
          }

          var labelProperties = function(obj) {
            obj.text(function(d) {
                  var minutes = Math.floor(d/60);
                  return minutes + ' min';
                })
                .attr("x", function(d) {
                  var fromEdge = 20;
                  if(Math.floor(d/60)>9) {
                    fromEdge = 27;
                  }
                  return Math.floor(d/divisor) - fromEdge;
                })
                .attr("y", function(d, i) {
                  return i * (h / (dataset.length)) + yPad + 10;
                })
                .attr("font-family", "sans-serif")
                .attr("font-size", "11px")
                .attr("fill", "white");
          };

          bar = bar.data(dataset);

          var upBar = bar.transition().duration(tr_time);
          barProperties(upBar);
          var newBar = bar.enter().append('rect').attr("x", xPad);
          barProperties(newBar);
          bar.exit().remove();

          minTxt = minTxt.data(dataset);

          var upMin = minTxt.transition().duration(tr_time);
          labelProperties(upMin);
          var newMin = minTxt.enter().append("text");
          labelProperties(newMin);
        };

      });
    </script>
    <script type="text/javascript" src="insert-routes.js"></script>
    <script type="text/javascript" src="nextbus-talking.js"></script>
  </body>
</html>